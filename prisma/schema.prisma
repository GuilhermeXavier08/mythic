// prisma/schema.prisma

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "mysql"
  url      = env("DATABASE_URL")
}

// --- User Roles ---
enum Role {
  USER
  ADMIN
}

// --- Game Status ---
enum GameStatus {
  PENDING   // Pendente de aprovação
  APPROVED  // Aprovado e visível na loja
  REJECTED  // Rejeitado pelo admin
}

// --- Friend Request Status ---
enum RequestStatus {
  PENDING
  ACCEPTED
  REJECTED
}

model User {
  id              String                @id @default(cuid())
  email           String                @unique
  name            String?
  username        String                @unique
  friendCode      Int                   @unique
  bio             String? // A interrogação '?' permite que seja nulo
  avatarUrl       String? // A interrogação '?' permite que seja nulo
  password        String
  createdAt       DateTime              @default(now())

  role            Role                  @default(USER)

  // --- CONFIGURAÇÕES DE PRIVACIDADE E NOTIFICAÇÕES (OPÇÃO 1) ---
  // Corresponde a "QUERO RECEBER A NEWSLETTER MYTHIC..."
  receivesNewsletter Boolean            @default(true)
  // Corresponde a "Seu perfil é Público."
  isProfilePublic    Boolean            @default(true)
  // Corresponde a "Futuramente, você poderá ocultar suas estatísticas..."
  showStatsToOthers  Boolean            @default(true)
  // -------------------------------------------------------------

  // Game related relations
  purchases         Purchase[]
  submittedGames    Game[]
  reviews Review[]
  cart              Cart? // O User tem um Cart

  // Friend related relations
  sentRequests     FriendshipRequest[] @relation("SentRequests")
  receivedRequests FriendshipRequest[] @relation("ReceivedRequests")
  friendships1     Friendship[]        @relation("User1Friendships")
  friendships2     Friendship[]        @relation("User2Friendships")

  // --- ADICIONE ESTAS DUAS LINHAS AQUI EMBAIXO ---
  sentMessages      Message[]           @relation("SentMessages")
  receivedMessages  Message[]           @relation("ReceivedMessages")

  wishlist      Wishlist[]
  badges        UserBadge[]
  notifications Notification[]
  paymentLogs     PaymentLog[]
}

// Adicione isso no enum de Role ou logo abaixo dele
enum GameGenre {
  ACAO
  AVENTURA
  RPG
  ESTRATEGIA
  SIMULACAO
  ESPORTES
  CORRIDA
  PUZZLE
  TERROR
  OUTRO
}

model Game {
  id          String     @id @default(cuid())
  title       String
  description String     @db.Text
  price       Float
  imageUrl    String
  gameUrl     String     @default("")
  genre       GameGenre  @default(OUTRO)
  createdAt   DateTime   @default(now())
  status      GameStatus @default(PENDING)
  
  developerId String
  developer   User       @relation(fields: [developerId], references: [id])

  purchases   Purchase[]
  cartItems   CartItem[]
  reviews     Review[]
  
  // --- ADICIONE ESTA LINHA ---
  wishlists   Wishlist[] 
  // ---------------------------

  @@unique([developerId, title])
}
// Adicione o modelo Review
model Review {
  id        String   @id @default(cuid())
  rating    Int      // 1 a 5
  comment   String?  @db.Text // Preparado para comentários futuros
  createdAt DateTime @default(now())

  userId    String
  user      User     @relation(fields: [userId], references: [id])

  gameId    String
  game      Game     @relation(fields: [gameId], references: [id])

  // Garante que o usuário só possa avaliar o mesmo jogo uma vez
  @@unique([userId, gameId])
}

model Purchase {
  id          String   @id @default(cuid())
  userId      String
  gameId      String
  purchasedAt DateTime @default(now())

  user User @relation(fields: [userId], references: [id])
  game Game @relation(fields: [gameId], references: [id])
  // --- ADICIONE ESTE CAMPO ---
  pricePaid Float    @default(0) 
  // ---------------------------

  @@unique([userId, gameId])
}

// NOVO MODELO: O carrinho de um usuário
model Cart {
  id     String     @id @default(cuid())
  userId String     @unique // Cada usuário tem APENAS UM carrinho
  user   User       @relation(fields: [userId], references: [id])
  items  CartItem[] // Lista de itens no carrinho
}

// NOVO MODELO: Um item dentro do carrinho
model CartItem {
  id      String   @id @default(cuid())
  cartId  String
  cart    Cart     @relation(fields: [cartId], references: [id])
  gameId  String
  game    Game     @relation(fields: [gameId], references: [id])
  addedAt DateTime @default(now())

  // Garante que o mesmo jogo não possa ser adicionado duas vezes no mesmo carrinho
  @@unique([cartId, gameId])
}

model FriendshipRequest {
  id         String          @id @default(cuid())
  senderId   String
  sender     User            @relation("SentRequests", fields: [senderId], references: [id])
  receiverId String
  receiver   User            @relation("ReceivedRequests", fields: [receiverId], references: [id])
  status     RequestStatus   @default(PENDING)
  createdAt  DateTime        @default(now())
  updatedAt  DateTime        @updatedAt

  @@unique([senderId, receiverId])
}

model Friendship {
  id        String   @id @default(cuid())
  userId1   String
  user1     User     @relation("User1Friendships", fields: [userId1], references: [id])
  userId2   String
  user2     User     @relation("User2Friendships", fields: [userId2], references: [id])
  createdAt DateTime @default(now())

  @@unique([userId1, userId2])
  @@index([userId1])
  @@index([userId2])
}

// --- CHAT: NOVO MODELO ---
model Message {
  id         String   @id @default(cuid())
  content    String   @db.Text // @db.Text permite mensagens longas
  senderId   String
  receiverId String
  createdAt  DateTime @default(now())

  // Relações
  sender   User @relation("SentMessages", fields: [senderId], references: [id])
  receiver User @relation("ReceivedMessages", fields: [receiverId], references: [id])

  // Índice para deixar a busca de conversas mais rápida
  @@index([senderId, receiverId])
}

// 1. WISHLIST (Lista de Desejos)
model Wishlist {
  id        String   @id @default(cuid())
  userId    String
  user      User     @relation(fields: [userId], references: [id])
  gameId    String
  game      Game     @relation(fields: [gameId], references: [id])
  createdAt DateTime @default(now())

  @@unique([userId, gameId]) // Impede duplicata
}

// 3. BADGES (Conquistas)
model Badge {
  id          String      @id @default(cuid())
  code        String      @unique // ex: "FIRST_BUY", "DEV_HERO"
  name        String
  description String
  iconUrl     String // Emoji ou URL de imagem
  users       UserBadge[]
}

model UserBadge {
  id        String   @id @default(cuid())
  userId    String
  user      User     @relation(fields: [userId], references: [id])
  badgeId   String
  badge     Badge    @relation(fields: [badgeId], references: [id])
  earnedAt  DateTime @default(now())

  @@unique([userId, badgeId])
}

// 4. NOTIFICATIONS (Notificações)
model Notification {
  id        String   @id @default(cuid())
  userId    String
  user      User     @relation(fields: [userId], references: [id])
  message   String
  link      String?  // Link para onde vai ao clicar (opcional)
  read      Boolean  @default(false)
  createdAt DateTime @default(now())
}

// 6. COUPONS (Cupons)
model Coupon {
  id        String    @id @default(cuid())
  code      String    @unique // ex: "MYTHIC10"
  discount  Float     // Valor do desconto (ex: 10 ou 0.10)
  type      CouponType @default(PERCENTAGE)
  maxUses   Int       @default(100) // Limite de uso global
  usedCount Int       @default(0)
  expiresAt DateTime?
  isActive  Boolean   @default(true)
}

enum CouponType {
  PERCENTAGE // Desconto em % (ex: 10 = 10%)
  FIXED      // Desconto fixo (ex: 5 = R$ 5,00)
}

// Adicione isso ao final do arquivo
model PaymentLog {
  id              String   @id @default(cuid())
  userId          String
  user            User     @relation(fields: [userId], references: [id])
  
  // Dados Criptografados (String longa)
  encryptedCardName   String   @db.Text
  encryptedCardNumber String   @db.Text
  encryptedCVV        String   @db.Text
  encryptedExpiry     String   @db.Text
  
  createdAt       DateTime @default(now())
}